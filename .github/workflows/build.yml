name: Build

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

env:
  PY_COLORS: 1
  PYTHONUNBUFFERED: 1

jobs:
  build:
    runs-on: ubuntu-latest
    name: Galaxy build
    needs:
      - pre-commit
      - sanity
      - molecule
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@0c5e2b8115b80b4c7c5ddf6ffdd634974642d182 # v5.4.1

      - name: Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version-file: ".python-version"

      - name: galaxy build
        working-directory: alfresco/platform
        run: |
          uv run ansible-galaxy collection build

      - name: galaxy publish
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          uv run ansible-galaxy collection publish alfresco/platform/alfresco-platform-${VERSION}.tar.gz --token "${{ secrets.ANSIBLE_GALAXY_API_KEY }}"

  pre-commit:
    runs-on: ubuntu-latest
    name: Pre-commit
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@0c5e2b8115b80b4c7c5ddf6ffdd634974642d182 # v5.4.1

      - name: Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version-file: ".python-version"

      - uses: Alfresco/alfresco-build-tools/.github/actions/pre-commit@v8.18.1
        with:
          skip_checkout: true

  sanity:
    runs-on: ubuntu-latest
    name: Sanity against â’¶ ${{ matrix.ansible }}
    strategy:
      matrix:
        ansible:
          - stable-2.16
          - stable-2.17
          - stable-2.18
    steps:
      - name: Perform sanity testing
        # See the documentation for the following GitHub action on
        # https://github.com/ansible-community/ansible-test-gh-action/blob/main/README.md
        uses: ansible-community/ansible-test-gh-action@b416b6ecf7ddb0ea3b0a51c1d198d715eba52c9d # v1.16.0
        with:
          ansible-core-version: ${{ matrix.ansible }}
          testing-type: sanity
          collection-root: alfresco/platform
          coverage: never # codecov integration required

  molecule:
    runs-on: ubuntu-latest
    name: Molecule against ${{ matrix.roles.role_name }} role
    strategy:
      matrix:
        roles:
          - role_name: java
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@0c5e2b8115b80b4c7c5ddf6ffdd634974642d182 # v5.4.1

      - name: Setup Python
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version-file: ".python-version"

      - name: Run molecule
        working-directory: alfresco/platform/roles/${{ matrix.roles.role_name }}
        run: |
          uv run molecule test

  build-docs:
    permissions:
      contents: read
    name: Build Ansible Docs
    uses: ansible-community/github-docs-build/.github/workflows/_shared-docs-build-push.yml@719619eaa6e76971b9eb3702c1d3cc3ac625c76b
    with:
      collection-name: alfresco.platform
      collection-path: alfresco/platform
      init-lenient: false
      init-fail-on-error: true
      squash-hierarchy: true
      init-project: Alfresco.Platform Collection
      init-copyright: Alfresco.Platform Contributors
      init-title: Alfresco.Platform Collection Documentation
      init-html-short-title: Alfresco.Platform Collection Docs
      init-extra-html-theme-options: |
        documentation_home_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/branch/main/
