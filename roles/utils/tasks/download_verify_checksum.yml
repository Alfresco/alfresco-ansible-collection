- name: Set artifact variables
  ansible.builtin.set_fact:
    utils_artifact_path: "{{ artifact.dest | default('./' + (artifact.url | basename)) }}"
    utils_checksum_type: "{{ artifact.checksum_type | default('sha1') }}"
    utils_checksum_url: "{{ artifact.url }}.{{ artifact.checksum_type | default('sha1') }}"

- name: Fetch checksum file
  ansible.builtin.get_url:
    url: "{{ utils_checksum_url }}"
    dest: "{{ utils_artifact_path }}.{{ utils_checksum_type }}"
    mode: "0644"
    url_username: "{{ artifact.username | default(omit) }}"
    url_password: "{{ artifact.password | default(omit) }}"
  register: utils_checksum_download
  retries: 3
  delay: 5
  until: utils_checksum_download is succeeded

- name: Read checksum file
  ansible.builtin.slurp:
    src: "{{ utils_artifact_path }}.{{ utils_checksum_type }}"
  register: utils_checksum_file

- name: Parse checksum
  ansible.builtin.set_fact:
    utils_checksum_text: "{{ utils_checksum_file.content | b64decode | trim }}"
    utils_parsed_checksum: >-
      {% set text = utils_checksum_file.content | b64decode | trim %}
      {% if text | length == utils_checksum_length_map[utils_checksum_type] %}
        {{ text }}
      {% else %}
        {{ text.split()[0] }}
      {% endif %}

- name: Normalize checksum for Ansible
  ansible.builtin.set_fact:
    utils_normalized_checksum: "{{ utils_checksum_type }}:{{ utils_parsed_checksum }}"

- name: Download artifact with checksum verification
  ansible.builtin.get_url:
    url: "{{ artifact.url }}"
    dest: "{{ utils_artifact_path }}"
    checksum: "{{ utils_normalized_checksum }}"
    mode: "0644"
    url_username: "{{ artifact.username | default(omit) }}"
    url_password: "{{ artifact.password | default(omit) }}"
