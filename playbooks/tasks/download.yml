- name: Set checksum defaults and metadata
  ansible.builtin.set_fact:
    checksum_type: "{{ checksum_type | default('sha1') }}"
    checksum_length_map:
      sha1: 40
      sha256: 64
      sha512: 128

- name: Set artifact variables
  ansible.builtin.set_fact:
    artifact_path: "{{ dest_path | default('./' + (resource_url | basename)) }}"
    checksum_url: "{{ resource_url }}.{{ checksum_type }}"

- name: Fetch checksum file
  ansible.builtin.get_url:
    url: "{{ checksum_url }}"
    dest: "{{ artifact_path }}.{{ checksum_type }}"
    mode: "0644"
    url_username: "{{ url_username | default(omit) }}"
    url_password: "{{ url_password | default(omit) }}"
  register: checksum_download
  retries: 3
  delay: 5
  until: checksum_download is succeeded

- name: Read checksum file from remote host
  ansible.builtin.slurp:
    src: "{{ artifact_path }}.{{ checksum_type }}"
  register: checksum_file

- name: Parse checksum
  ansible.builtin.set_fact:
    checksum_text: "{{ checksum_file.content | b64decode | trim }}"
    parsed_checksum: >-
      {% if (checksum_file.content | b64decode | trim) | length == checksum_length_map[checksum_type] %}
        {{ checksum_file.content | b64decode | trim }}
      {% else %}
        {{ (checksum_file.content | b64decode | trim).split()[0] }}
      {% endif %}

- name: Normalize checksum for Ansible
  ansible.builtin.set_fact:
    normalized_checksum: "{{ checksum_type }}:{{ parsed_checksum }}"

- name: Download artifact with checksum verification
  ansible.builtin.get_url:
    url: "{{ resource_url }}"
    dest: "{{ artifact_path }}"
    checksum: "{{ normalized_checksum }}"
    mode: "0644"
    url_username: "{{ url_username | default(omit) }}"
    url_password: "{{ url_password | default(omit) }}"
